# Разработка ассемблера и интерпретатора для учебной виртуальной машины (УВМ)

## Оглавление

1. [Понимание системы команд УВМ](#1-понимание-системы-команд-увм)
   - [Структура команды](#структура-команды)
   - [Команды и их описание](#команды-и-их-описание)
2. [Разработка ассемблера](#2-разработка-ассемблера)
   - [Читаемое представление команд](#21-читаемое-представление-команд)
   - [Реализация ассемблера](#22-реализация-ассемблера)
3. [Разработка интерпретатора](#3-разработка-интерпретатора)
   - [Реализация интерпретатора](#31-реализация-интерпретатора)
4. [Тестирование](#4-тестирование)
   - [Тесты ассемблера](#41-тесты-ассемблера)
   - [Тесты интерпретатора](#42-тесты-интерпретатора)
   - [Запуск тестов](#43-запуск-тестов)
5. [Тестовая программа](#5-тестовая-программа)
6. [Примеры запуска](#6-примеры-запуска)
7. [Результаты тестирования](#7-результаты-тестирования)
8. [Примечания](#8-примечания)

---

## 1. Понимание системы команд УВМ

### Структура команды

Каждая команда УВМ имеет размер 4 байта (32 бита). Биты команды распределены следующим образом:

- **Биты 0–4 (5 бит):** Код операции (A).
- **Биты 5–N:** Операнд или дополнительные данные (B).
  - Количество бит в операнде зависит от команды (N может быть разным для разных команд).
- **Оставшиеся биты устанавливаются в ноль.**

**Примечание:** Нумерация битов начинается с младшего бита (самого правого).

### Команды и их описание

1. **Загрузка константы**

   - **Код операции (A):** 16
   - **Операнд (B):** Значение, которое будет помещено на стек.
     - **Биты операнда:** 13 бит (биты 5–17)
   - **Описание:** Помещает значение B на вершину стека.
   - **Тестовый пример:** A=16, B=48
     - Бинарная команда: `0x10, 0x06, 0x00, 0x00`

2. **Чтение значения из памяти**

   - **Код операции (A):** 30
   - **Описание:** Снимает адрес с вершины стека, читает значение из памяти по этому адресу, помещает его на стек.
   - **Операнд не используется.**
   - **Тестовый пример:** A=30
     - Бинарная команда: `0x1E, 0x00, 0x00, 0x00`

3. **Запись значения в память**

   - **Код операции (A):** 19
   - **Операнд (B):** Смещение
     - **Биты операнда:** 11 бит (биты 5–15)
   - **Описание:** Снимает значение и адрес с вершины стека, записывает значение в память по адресу `адрес + смещение`.
   - **Тестовый пример:** A=19, B=425
     - Бинарная команда: `0x13, 0xA9, 0x03, 0x00`

4. **Бинарная операция: вычитание**

   - **Код операции (A):** 26
   - **Операнд (B):** Смещение
     - **Биты операнда:** 11 бит (биты 5–15)
   - **Описание:**
     - **Первый операнд:** снимается с вершины стека.
     - **Адрес для второго операнда:** снимается со стека и к нему добавляется смещение (B).
     - **Второй операнд:** значение из памяти по вычисленному адресу.
     - **Операция:** первый операнд минус второй операнд.
     - **Результат:** помещается на стек.
   - **Тестовый пример:** A=26, B=784
     - Бинарная команда: `0x1A, 0x10, 0x03, 0x00`

## 2. Разработка ассемблера

### 2.1. Читаемое представление команд

Определим простой синтаксис для каждой команды:

- **LOADC value**
  - Загрузка константы на стек.
- **READMEM**
  - Чтение значения из памяти по адресу с вершины стека.
- **WRITEMEM offset**
  - Запись значения в память по адресу `адрес + смещение`.
- **SUB offset**
  - Вычитание значения из памяти по адресу `адрес + смещение` из значения на вершине стека.

### 2.2. Реализация ассемблера

Ассемблер реализует следующие шаги:

1. **Парсинг исходного файла:**
   - Чтение исходного файла построчно.
   - Разбор каждой строки на команду и операнды.
2. **Генерация бинарного кода:**
   - Кодирование каждой команды в соответствии с заданной структурой.
   - Запись бинарных данных в выходной файл.
3. **Создание лог-файла:**
   - Запись ассемблированных инструкций в формате CSV.

- **Класс `Assembler`:**
  - Метод `assemble` читает входной файл, разбирает команды и записывает бинарный код и лог.
  - Метод `encode_instruction` кодирует команду в 4-байтовое бинарное представление.
  - Кодирование учитывает количество бит для операнда, которое зависит от команды.

**Запуск ассемблера:**

```bash
python assembler.py -i <input_program.asm> -o <output_program.bin> -l <program_log.csv>
```

## 3. Разработка интерпретатора

### Реализация интерпретатора

Интерпретатор выполняет следующие действия:

1. **Загрузка бинарного файла:**
   - Чтение бинарного файла и разбор инструкций.
2. **Инициализация памяти и стека:**
   - Создание памяти заданного размера.
   - Инициализация стека.
3. **Выполнение инструкций:**
   - Последовательное выполнение инструкций из бинарного файла.
   - Обработка каждой инструкции в соответствии с ее кодом операции.
4. **Сохранение результатов:**
   - Запись значений из указанного диапазона памяти в CSV-файл.

- **Класс `Interpreter`:**
  - Метод `run` выполняет инструкции из бинарного файла.
  - Обрабатывает каждый код операции в соответствии с его функциональностью.
  - Учитывает количество бит операнда для каждой команды.
  - Метод `run_instructions` содержит логику выполнения инструкций.

**Запуск интерпретатора:**

```bash
python interpreter.py -i <output_program.bin> -o <result_output.csv> --mem-start <start_address> --mem-end <end_address>
```

## 4. Тестирование

### 4.1. Тесты ассемблера

- **Файл `test_assembler.py`** содержит тесты для каждой команды.
- Проверяется корректность кодирования инструкций.
- Тесты проверяют, что бинарный код, генерируемый ассемблером, соответствует ожидаемому.

### 4.2. Тесты интерпретатора

- **Файл `test_interpreter.py`** содержит тесты для выполнения каждой команды.
- Проверяется корректность выполнения инструкций интерпретатором.
- Тесты проверяют, что состояние стека и памяти после выполнения инструкций соответствует ожидаемому.

### 4.3. Запуск тестов

```bash
python test_assembler.py
python test_interpreter.py
```

## 5. Тестовая программа

**Файл:** `vector_subtraction.asm`

Выполняет поэлементное вычитание двух векторов длиной 5. Результат записывается в новый вектор.

- Вектор A хранится в памяти по адресам 0–4.
- Вектор B хранится в памяти по адресам 5–9.
- Результат (A[i] - B[i]) записывается в память по адресам 10–14.

Программа:

```asm
; Поэлементное вычитание двух векторов длиной 5

; Обработка элемента 0
LOADC 0
READMEM
LOADC 5
SUB 0
LOADC 10
WRITEMEM 0

; Обработка элемента 1
LOADC 1
READMEM
LOADC 6
SUB 0
LOADC 11
WRITEMEM 0

; Обработка элемента 2
LOADC 2
READMEM
LOADC 7
SUB 0
LOADC 12
WRITEMEM 0

; Обработка элемента 3
LOADC 3
READMEM
LOADC 8
SUB 0
LOADC 13
WRITEMEM 0

; Обработка элемента 4
LOADC 4
READMEM
LOADC 9
SUB 0
LOADC 14
WRITEMEM 0
```

## 6. Примеры запуска

### Ассемблирование программы:

```bash
python assembler.py -i vector_subtraction.asm -o vector_subtraction.bin -l vector_subtraction_log.csv
```

### Выполнение программы:

```bash
python interpreter.py -i vector_subtraction.bin -o result_output.csv --mem-start 10 --mem-end 14
```

## 7. Результаты тестирования

### Запуск тестов

```bash
python test_assembler.py
python test_interpreter.py
```

### Вывод тестов

#### Тесты ассемблера:

```
....
----------------------------------------------------------------------
Ran 4 tests in 0.005s

OK
```

#### Тесты интерпретатора:

```
Memory[10] = 9, Expected: 9
Memory[11] = 18, Expected: 18
Memory[12] = 27, Expected: 27
Memory[13] = 36, Expected: 36
Memory[14] = 45, Expected: 45
.....
----------------------------------------------------------------------
Ran 5 tests in 0.005s

OK
```

### Результат выполнения `vector_subtraction.asm`

После выполнения программы `vector_subtraction.asm`, в памяти по адресам 10–14 находятся результаты вычитания:

```
Address,Value
10,9
11,18
12,27
13,36
14,45
```

## 8. Примечания

- **Требования:** Python 3.x
- **Входные файлы:**
  - Ассемблер принимает файлы с расширением `.asm`.
  - Интерпретатор принимает бинарные файлы, созданные ассемблером.
- **Логи и результаты:**
  - Ассемблер и интерпретатор генерируют CSV-файлы с логами и результатами выполнения.
- **Запуск тестов:**
  - Тестовые файлы `test_assembler.py` и `test_interpreter.py` содержат подробные тесты для каждой команды.
- **Обработка ошибок:**
  - Ассемблер и интерпретатор проверяют корректность входных данных и выдают понятные сообщения об ошибках.
---
